local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local StarterGui = game:GetService("StarterGui")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Debris = game:GetService("Debris")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer

local function newNotification(title, message, duration)
    StarterGui:SetCore("SendNotification",{
        Title = title,
        Text = message,
        Duration = duration or 5
    })
end

-- üîó URL RAW DEL GITHUB
local GITHUB_URL = "https://raw.githubusercontent.com/nortgt/v/refs/heads/main/whitelist.json"

-- Funci√≥n para convertir fechas
local function parseDateTime(dateString)
    if not dateString or dateString == "" then return nil end

    local day, month, year, hour, minute =
        dateString:match("(%d+)/(%d+)/(%d+) (%d+):(%d+)")

    if day then
        return os.time({
            day = tonumber(day),
            month = tonumber(month),
            year = tonumber(year),
            hour = tonumber(hour),
            min = tonumber(minute),
            sec = 0
        })
    end

    return nil
end

-- Descargar whitelist desde GitHub
local function loadWhitelist()
    local success, result = pcall(function()
        return game:HttpGet(GITHUB_URL)
    end)

    if not success then
        newNotification("‚ö† Error", "No se pudo cargar la whitelist desde GitHub.")
        return {}
    end

    local parsed = HttpService:JSONDecode(result)
    return parsed or {}
end

-- Validar usuario
local function isUserWhitelisted(whitelist, username)
    username = username:lower()
local userData = whitelist[username]
    if not userData then
        return false, "NOT_IN_LIST"
    end

    -- Verificar expiraci√≥n
    if userData.expires then
        local expirationTimestamp = parseDateTime(userData.expires)
        if expirationTimestamp and os.time() > expirationTimestamp then
            return false, userData.expires
        end
    end

    return true, userData.type
end

-- Verificaci√≥n principal
local function verifyWhitelist()
    local whitelist = loadWhitelist()
    local username = LocalPlayer.Name:lower()

    local allowed, info = isUserWhitelisted(whitelist, username)

    if not allowed then
        task.wait(1)

        if info == "NOT_IN_LIST" then
            newNotification("‚ùå Acceso Denegado", "No est√°s en la whitelist.")
        else
            newNotification("‚ùå Tu whitelist expir√≥", "Expir√≥ el: " .. info)
        end

        return false
    end
    -- Aprobado
	createRankTag(LocalPlayer, info)
    return true
end

-- Bloquear si no tiene whitelist v√°lida
if not verifyWhitelist() then
    return
end

local function createRankTag(player, rankType)
	player.CharacterAdded:Connect(function(character)

    local head = character:WaitForChild("Head")

    local old = head:FindFirstChild("NameTag")
    if old then old:Destroy() end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "NameTag"
    billboard.Size = UDim2.new(5, 0, 2.8, 0)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 120
    billboard.Parent = head

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundTransparency = 1
    frame.Parent = billboard

    local rankFrame = Instance.new("Frame")
    rankFrame.Size = UDim2.new(0.7, 0, 0.28, 0)
    rankFrame.Position = UDim2.new(0.15, 0, 0.43, 0)
    rankFrame.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
    rankFrame.BackgroundTransparency = 0.2
    rankFrame.Parent = frame

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 14)
    corner.Parent = rankFrame

    local rankText = Instance.new("TextLabel")
    rankText.Size = UDim2.new(1, 0, 1, 0)
    rankText.BackgroundTransparency = 1
    rankText.TextScaled = true
    rankText.Font = Enum.Font.GothamBold
    rankText.TextColor3 = Color3.new(1, 1, 1)
    rankText.TextTransparency = 0.1
    rankText.Text = tostring(rankType):upper()
    rankText.Parent = rankFrame

    local nameText = Instance.new("TextLabel")
    nameText.Size = UDim2.new(1, 0, 0.3, 0)
    nameText.Position = UDim2.new(0.15, 0, 0.73, 0)
    nameText.BackgroundTransparency = 1
    nameText.TextScaled = true
    nameText.Font = Enum.Font.GothamMedium
    nameText.TextColor3 = Color3.new(0, 0, 0)
    nameText.Text = "@" .. player.DisplayName
    nameText.TextTransparency = 0.2
    nameText.Font = Enum.Font.FredokaOne
    nameText.TextXAlignment = Enum.TextXAlignment.Left
    nameText.Parent = frame
	end)
end

local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
local Window = WindUI:CreateWindow({
    Title = "Hexagon Client",
	Icon = "rbxassetid://130681274976406",
    Author = "Admin",
    Size = UDim2.fromOffset(550,450),
    Transparent = true,
    Theme = "Dark",
})

local playerNames = {}
for _, player in ipairs(Players:GetPlayers()) do
    table.insert(playerNames, player.Name)
end
local SelectedPlayer = LocalPlayer.Name

local TabComandos = Window:Tab({ Title = "Comandos", Icon = "terminal" })
local Dropdown = TabComandos:Dropdown({
    Title = "Select Player",
    Values = playerNames,
    Callback = function(value)
        SelectedPlayer = value
    end
})

-- Update player list on join/leave
table.insert(connections, Players.PlayerAdded:Connect(function(player)
    table.insert(playerNames, player.Name)
    Dropdown:SetValues(playerNames)
end))

table.insert(connections, Players.PlayerRemoving:Connect(function(player)
    for i, name in ipairs(playerNames) do
        if name == player.Name then
            table.remove(playerNames, i)
            break
        end
    end
    Dropdown:SetValues(playerNames)
    RemoveJail(player)
end))

-- Command Buttons
local buttons = {
    { "Verificar Hubs", ";verifique" },
    { "Kick", ";kick" },
    { "Kill", ";kill" },
    { "Kill Plus", ";killplus" },
    { "Fling", ";fling" },
    { "Bring", ";bring" },
    { "Jail", ";jail" },
    { "Unjail", ";unjail" },
    { "Freeze", ";freeze" },
    { "Unfreeze", ";unfreeze" },
    { "Tag", ";tag" },
    { "Untag", ";untag" },
    { "Tag All", ";tag all" },
    { "Untag All", ";untag all" },
    { "Float", ";float" },
    { "Jumpscare 1", ";jumps1" },
    { "Jumpscare 2", ";jumps2" },
    { "Jumpscare 3", ";jumps3" },
    { "Jumpscare 4", ";jumps4" }
}

for _, button in ipairs(buttons) do
    local title, cmd = button[1], button[2]
    TabComandos:Button({
        Title = title,
        Callback = function()
            if cmd == ";jail" then
                CreateAndManageJail(Players:FindFirstChild(SelectedPlayer))
            elseif cmd == ";unjail" then
                RemoveJail(Players:FindFirstChild(SelectedPlayer))
            else
                sendChat(cmd .. (string.find(cmd, "^;[%w]+%s+all$") or not string.find(cmd, "^;jumps") and " " .. SelectedPlayer or ""))
            end
        end
    })
end
