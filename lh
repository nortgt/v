local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local StarterGui = game:GetService("StarterGui")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Debris = game:GetService("Debris")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer

local function newNotification(title, message, duration)
    StarterGui:SetCore("SendNotification",{
        Title = title,
        Text = message,
        Duration = duration or 5
    })
end

-- üîó WHITELIST WITH GITHUB
local GITHUB_URL = "https://raw.githubusercontent.com/nortgt/v/refs/heads/main/whitelist.json"

-- Funci√≥n para convertir fechas
local function parseDateTime(dateString)
    if not dateString or dateString == "" then return nil end

    local day, month, year, hour, minute =
        dateString:match("(%d+)/(%d+)/(%d+) (%d+):(%d+)")

    if day then
        return os.time({
            day = tonumber(day),
            month = tonumber(month),
            year = tonumber(year),
            hour = tonumber(hour),
            min = tonumber(minute),
            sec = 0
        })
    end

    return nil
end

-- Descargar whitelist desde GitHub
local function loadWhitelist()
    local success, result = pcall(function()
        return game:HttpGet(GITHUB_URL)
    end)

    if not success then
        newNotification("‚ö† Error", "No se pudo cargar la whitelist desde GitHub.")
        return {}
    end

    local parsed = HttpService:JSONDecode(result)
    return parsed or {}
end

-- Validar usuario
local function isUserWhitelisted(whitelist, username)
    username = username:lower()
local userData = whitelist[username]
    if not userData then
        return false, "NOT_IN_LIST"
    end

    -- Verificar expiraci√≥n
    if userData.expires then
        local expirationTimestamp = parseDateTime(userData.expires)
        if expirationTimestamp and os.time() > expirationTimestamp then
            return false, userData.expires
        end
    end

    return true, userData.type
end

-- Verificaci√≥n principal
local function verifyWhitelist()
    local whitelist = loadWhitelist()
    local username = LocalPlayer.Name:lower()

    local allowed, info = isUserWhitelisted(whitelist, username)

    if not allowed then
        task.wait(1)

        if info == "NOT_IN_LIST" then
            newNotification("‚ùå Acceso Denegado", "No est√°s en la whitelist.")
        else
            newNotification("‚ùå Tu whitelist expir√≥", "Expir√≥ el: " .. info)
        end

        return false
    end

    -- Aprobado
    return true
end

-- Bloquear si no tiene whitelist v√°lida
if not verifyWhitelist() then
    return
end


local function ExecuteLog()
    local placeId = game.PlaceId
    local jobId = game.JobId
    local userId = LocalPlayer.UserId
    local dataHora = os.date("%d/%m/%Y %H:%M:%S")

    -- Intentar obtener la miniatura real de la API de Roblox
    local avatarUrl = nil
    local success, response = pcall(function()
        local apiUrl = "https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=" .. userId .. "&size=420x420&format=Png&isCircular=false"
        return HttpService:GetAsync(apiUrl)
    end)

    if success then
        local decoded = HttpService:JSONDecode(response)
        if decoded and decoded.data and decoded.data[1] and decoded.data[1].imageUrl then
            avatarUrl = decoded.data[1].imageUrl
        else
            warn("No se encontr√≥ imageUrl en la respuesta del API de miniaturas:", response)
        end
    else
        warn("Error al llamar al API de miniaturas:", response)
    end

    -- Si no obtuvimos avatar, puedes poner una URL por defecto
    if not avatarUrl then
        avatarUrl = "https://via.placeholder.com/420"  -- o cualquier imagen fallback v√°lida
    end

    local data = {
        embeds = {{
            title = "üíé An Admin executed Hexagon",
            color = 1193113,
            thumbnail = {
				url = avatarUrl
			},
            fields = {
                {name = "üìÖ Date", value = dataHora, inline = false},
                {name = "üéÆ Game", value = game:GetService("MarketplaceService"):GetProductInfo(placeId).Name, inline = false},
                {name = "üë§ Player", value = LocalPlayer.Name, inline = false},
                {name = "üÜî User ID", value = tostring(userId), inline = false},
                {name = "üìù Account Age", value = LocalPlayer.AccountAge .. " Days", inline = false},
                {name = "üåé Language", value = LocalPlayer.LocaleId, inline = false},
                {name = "üíª Executor", value = identifyexecutor and identifyexecutor() or "Unknown", inline = false},
                {name = "üåê Server JobId", value = jobId, inline = false},
                {name = "üìå Teleport", value = "game:GetService(\"TeleportService\"):TeleportToPlaceInstance("..placeId..", \""..jobId.."\")", inline = false},
            }
        }}
    }

    local body = HttpService:JSONEncode(data)
    pcall(function()
        request({
            Url = "https://discord.com/api/webhooks/1433989880525881375/I9QncYRuM98BYQ1V3G0cGWb3ydd1IFAIJY_AHfMGkaDmCbl3HUA-ZbHHEB_vaoxx0QHK",
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = body
        })
    end)
end

ExecuteLog()


local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
local Window = WindUI:CreateWindow({
    Title = "Hexagon Client",
	Icon = "rbxassetid://130681274976406",
    Author = "Admin",
    Size = UDim2.fromOffset(550,450),
    Transparent = true,
    Theme = "Dark",
})

local playerNames = {}
for _, player in ipairs(Players:GetPlayers()) do
    table.insert(playerNames, player.Name)
end
local SelectedPlayer = LocalPlayer.Name

local TabComandos = Window:Tab({ Title = "Comandos", Icon = "terminal" })
local Dropdown = TabComandos:Dropdown({
    Title = "Select Player",
    Values = playerNames,
    Callback = function(value)
        SelectedPlayer = value
    end
})

-- Update player list on join/leave
table.insert(connections, Players.PlayerAdded:Connect(function(player)
    table.insert(playerNames, player.Name)
    Dropdown:SetValues(playerNames)
end))

table.insert(connections, Players.PlayerRemoving:Connect(function(player)
    for i, name in ipairs(playerNames) do
        if name == player.Name then
            table.remove(playerNames, i)
            break
        end
    end
    Dropdown:SetValues(playerNames)
    RemoveJail(player)
end))

-- Command Buttons
local buttons = {
    { "Verificar Hubs", ";verifique" },
    { "Kick", ";kick" },
    { "Kill", ";kill" },
    { "Kill Plus", ";killplus" },
    { "Fling", ";fling" },
    { "Bring", ";bring" },
    { "Jail", ";jail" },
    { "Unjail", ";unjail" },
    { "Freeze", ";freeze" },
    { "Unfreeze", ";unfreeze" },
    { "Tag", ";tag" },
    { "Untag", ";untag" },
    { "Tag All", ";tag all" },
    { "Untag All", ";untag all" },
    { "Float", ";float" },
    { "Jumpscare 1", ";jumps1" },
    { "Jumpscare 2", ";jumps2" },
    { "Jumpscare 3", ";jumps3" },
    { "Jumpscare 4", ";jumps4" }
}

for _, button in ipairs(buttons) do
    local title, cmd = button[1], button[2]
    TabComandos:Button({
        Title = title,
        Callback = function()
            if cmd == ";jail" then
                CreateAndManageJail(Players:FindFirstChild(SelectedPlayer))
            elseif cmd == ";unjail" then
                RemoveJail(Players:FindFirstChild(SelectedPlayer))
            else
                sendChat(cmd .. (string.find(cmd, "^;[%w]+%s+all$") or not string.find(cmd, "^;jumps") and " " .. SelectedPlayer or ""))
            end
        end
    })
end
